name: Run Benchmark

on:
  workflow_dispatch:  # manual trigger from GitHub UI
  push:
    branches: [main]
    paths: [main.py, .github/workflows/benchmark.yml]

jobs:
  benchmark:
    runs-on: macos-15  # Apple Silicon M1, Xcode 16
    timeout-minutes: 30

    steps:
      - name: Checkout hackathon repo
        uses: actions/checkout@v4
        with:
          path: functiongemma-hackathon

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Clone cactus
        run: git clone --depth 1 https://github.com/cactus-compute/cactus

      - name: Build cactus native library
        run: cd cactus/cactus && bash build.sh

      - name: Install Python dependencies
        run: pip install torch transformers sentencepiece huggingface_hub google-genai

      - name: Download and convert model weights (reconvert from source)
        env:
          HF_TOKEN: ${{ secrets.HUGGINGFACE_API_KEY }}
        run: |
          cd cactus/python && python3 -m src download google/functiongemma-270m-it --reconvert --token "$HF_TOKEN"
          ls -la ../weights/functiongemma-270m-it/
          test -f ../weights/functiongemma-270m-it/config.txt || (echo "ERROR: config.txt missing" && exit 1)

      - name: Fix tied embeddings (force separate output_weight.weights)
        run: |
          WEIGHTS_DIR=cactus/weights/functiongemma-270m-it
          cp "$WEIGHTS_DIR/token_embeddings.weights" "$WEIGHTS_DIR/output_weight.weights"
          sed -i '' 's/tie_word_embeddings=true/tie_word_embeddings=false/' "$WEIGHTS_DIR/config.txt"
          echo "=== config.txt after fix ==="
          cat "$WEIGHTS_DIR/config.txt"
          echo "=== weight files ==="
          ls -la "$WEIGHTS_DIR/"

      - name: Run benchmark
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CACTUS_NO_CLOUD_TELE: "1"
        run: python3 functiongemma-hackathon/benchmark.py
