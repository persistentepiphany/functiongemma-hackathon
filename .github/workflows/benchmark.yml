name: Run Benchmark

on:
  workflow_dispatch:  # manual trigger from GitHub UI
  push:
    branches: [main]
    paths: [main.py]

jobs:
  benchmark:
    runs-on: macos-15  # Apple Silicon M1, Xcode 16
    timeout-minutes: 30

    steps:
      - name: Checkout hackathon repo
        uses: actions/checkout@v4
        with:
          path: functiongemma-hackathon

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Clone cactus
        run: git clone --depth 1 https://github.com/cactus-compute/cactus

      - name: Build cactus native library
        run: cd cactus/cactus && bash build.sh

      - name: Download model weights
        run: |
          pip install huggingface_hub
          python3 << 'PYEOF'
          from huggingface_hub import hf_hub_download, list_repo_files
          import zipfile, os

          repo_id = "Cactus-Compute/functiongemma-270m-it"
          out_dir = "cactus/weights/functiongemma-270m-it"
          os.makedirs(out_dir, exist_ok=True)

          # Find the apple or standard int8 zip
          files = list_repo_files(repo_id, repo_type="model")
          candidates = [
              "weights/functiongemma-270m-it-int8-apple.zip",
              "weights/functiongemma-270m-it-int8.zip",
          ]
          for c in candidates:
              if c in files:
                  print(f"Downloading {c}...")
                  path = hf_hub_download(repo_id, c, repo_type="model")
                  with zipfile.ZipFile(path) as z:
                      z.extractall(out_dir)
                  print(f"Extracted to {out_dir}")
                  break
          else:
              # Fallback: download whatever zip is available
              for f in sorted(files):
                  if f.startswith("weights/") and f.endswith(".zip"):
                      print(f"Downloading {f}...")
                      path = hf_hub_download(repo_id, f, repo_type="model")
                      with zipfile.ZipFile(path) as z:
                          z.extractall(out_dir)
                      print(f"Extracted to {out_dir}")
                      break
              else:
                  raise RuntimeError(f"No weight zips found in {repo_id}. Files: {files}")

          # Verify
          assert os.path.exists(os.path.join(out_dir, "config.txt")), "config.txt missing after extraction"
          print("Weights downloaded successfully!")
          PYEOF

      - name: Install Python dependencies
        run: pip install google-genai

      - name: Run benchmark
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CACTUS_NO_CLOUD_TELE: "1"
        run: python3 functiongemma-hackathon/benchmark.py
